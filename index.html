<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Envelope Letters Prototype</title>
  <style>
    :root{
      /* Match reference: dark stage + warm beige paper */
      --bg0:#0d0d0f;
      --bg1:#141417;

      --env:#efd9c6;
      --env2:#e9cfba;
      --envEdge: rgba(0,0,0,.12);

      --paper:#f6efe8;
      --paper2:#f3e8df;
      --paperEdge: rgba(0,0,0,.10);

      --ink:#1b1b1f;

      --shadow: rgba(0,0,0,.35);
      --soft: rgba(0,0,0,.22);

      --radius: 14px;
      --anim: 520ms;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 50% 15%, #1b1b20 0%, var(--bg1) 45%, var(--bg0) 100%);
      color:#fff;
      overflow:hidden;          /* prevent real scroll */
      touch-action:none;        /* gestures handled manually */
    }

    .app{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      position:relative;
    }

    /* simple “canvas”, not a glass phone */
    .canvas{
      width:min(980px, 98vw);
      height:min(560px, 92vh);
      position:relative;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border: 1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }

    .hud{
      position:absolute;
      top:12px;
      left:12px;
      right:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      pointer-events:none;
      z-index:50;
      opacity:.92;
    }
    .pill{
      pointer-events:none;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(6px);
    }

    .hint{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      z-index:60;
      font-size:12px;
      line-height:1.35;
      padding:10px 12px;
      border-radius:12px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      transition: opacity 220ms ease;
      max-width:min(720px, 92%);
      text-align:center;
    }
    .hint.hidden{ opacity:0; }

    /* =========================
       Envelope + letters stage
       ========================= */
    .stage{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .stack{
      width: 640px;
      height: 260px;
      position:relative;
    }

    /* Letters (folded stack) */
    .letters{
      position:absolute;
      left: 210px;
      top: 36px;
      width: 220px;
      height: 200px;
      z-index: 2;
      transform: translateY(0px);
      will-change: transform;
    }

    .sheet{
      position:absolute;
      inset:0;
      border-radius: 10px;
      background: linear-gradient(180deg, var(--paper) 0%, var(--paper2) 100%);
      border: 1px solid var(--paperEdge);
      box-shadow: 0 14px 28px var(--soft);
      overflow:hidden;
    }
    .sheet:nth-child(1){ transform: translateY(0px); }
    .sheet:nth-child(2){ transform: translateY(9px); opacity:.98; }
    .sheet:nth-child(3){ transform: translateY(18px); opacity:.96; }

    /* subtle lines like reference */
    .lines{
      position:absolute;
      left:18px; right:18px;
      top:18px; bottom:18px;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(27,27,31,.10) 0px,
          rgba(27,27,31,.10) 1px,
          transparent 1px,
          transparent 10px
        );
      opacity:.55;
    }

    /* Envelope body */
    .envelope{
      position:absolute;
      left: 165px;
      top: 78px;
      width: 310px;
      height: 175px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--env) 0%, var(--env2) 100%);
      border: 1px solid var(--envEdge);
      box-shadow: 0 18px 34px var(--shadow);
      cursor:pointer;
      user-select:none;
      z-index: 3;
      overflow:hidden;
    }

    /* Front “X” fold impression like the reference */
    .env-front{
      position:absolute;
      inset:0;
      opacity:.95;
      background:
        linear-gradient(135deg, rgba(255,255,255,.10), transparent 42%),
        linear-gradient(-135deg, rgba(255,255,255,.08), transparent 42%);
      clip-path: polygon(0 0, 50% 55%, 100% 0, 100% 100%, 0 100%);
    }

    /* Bottom pocket lip */
    .env-lip{
      position:absolute;
      left:0; right:0;
      bottom:0;
      height: 64px;
      background: linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.06));
      border-top: 1px solid rgba(0,0,0,.06);
    }

    /* Top flap (triangle) */
    .flap{
      position:absolute;
      left:0; right:0;
      top:-1px;
      height: 110px;
      background: linear-gradient(180deg, #f6e7da 0%, #ead2bd 100%);
      border-bottom: 1px solid rgba(0,0,0,.06);
      transform-origin: top center;
      transform: rotateX(0deg);
      transition: transform var(--anim) cubic-bezier(.2,.9,.2,1);
      clip-path: polygon(0 0, 100% 0, 50% 85%);
      z-index: 4;
    }

    /* envelope “press” feedback */
    .envelope:active{
      transform: scale(.985);
    }

    /* =========================
       Unfolded full-page viewer
       ========================= */
    .viewer{
      position:absolute;
      inset:0;
      opacity:0;
      pointer-events:none;
      transition: opacity 240ms ease;
      z-index: 20;
    }
    .viewer.active{
      opacity:1;
      pointer-events:auto;
    }

    .pages{
      height:100%;
      display:flex;
      width:300%;
      transform: translateX(0%);
      transition: transform 380ms cubic-bezier(.2,.9,.2,1);
    }

    .page{
      width:100%;
      height:100%;
      background: linear-gradient(180deg, #fbf6f1 0%, #f5eee7 100%);
      color: var(--ink);
      padding: 64px 40px 36px;
      position:relative;
    }

    .page h1{
      margin:0 0 12px;
      font-size: 30px;
      letter-spacing: -0.02em;
      font-weight: 700;
    }
    .page p{
      margin: 12px 0;
      line-height: 1.7;
      font-size: 16px;
      opacity: .9;
      max-width: 70ch;
    }

    .top-controls{
      position:absolute;
      top: 14px;
      left: 14px;
      right: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      z-index: 25;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(27,27,31,.14);
      background: rgba(255,255,255,.62);
      color: rgba(27,27,31,.78);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      cursor:pointer;
      backdrop-filter: blur(8px);
    }

    .pager{
      font-size: 12px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(27,27,31,.12);
      color: rgba(27,27,31,.70);
      user-select:none;
    }

    /* =========================
       State-driven styling
       ========================= */

    /* closed: flap down, letters hidden */
    body[data-state="closed"] .flap{ transform: rotateX(0deg); }
    body[data-state="closed"] .letters{
      transform: translateY(-38px);
      opacity: 0;
    }

    /* opened: flap up, letters peek */
    body[data-state="opened"] .flap{ transform: rotateX(140deg); }
    body[data-state="opened"] .letters{
      opacity: 1;
      transform: translateY(-18px);
    }

    /* pulling: we will set letters translateY via JS “scrub” */
    body[data-state="pulling"] .flap{ transform: rotateX(140deg); }
    body[data-state="pulling"] .letters{ opacity:1; }

    /* pulled: letters fully out, still folded */
    body[data-state="pulled"] .flap{ transform: rotateX(140deg); }

    /* unfold: envelope fades back */
    body[data-state="unfolding"] .envelope,
    body[data-state="unfolded"] .envelope{
      opacity: 0;
      transform: translateY(16px) scale(.96);
      transition: opacity 260ms ease, transform 520ms cubic-bezier(.2,.9,.2,1);
      pointer-events:none;
    }
    body[data-state="unfolding"] .letters,
    body[data-state="unfolded"] .letters{
      opacity: 0;
      transition: opacity 220ms ease;
    }

    @media (max-width: 720px){
      .stack{ transform: scale(.9); }
      .page{ padding: 56px 22px 28px; }
      .page h1{ font-size: 26px; }
      .page p{ font-size: 15px; }
    }
  </style>
</head>

<body data-state="closed">
  <div class="app">
    <div class="canvas" id="canvas">
      <div class="hud">
        <div class="pill" id="statePill">State: closed</div>
        <div class="pill" id="gesturePill">Gesture: —</div>
      </div>

      <div class="stage">
        <div class="stack" id="stack">
          <!-- Letters (folded) -->
          <div class="letters" id="letters" aria-hidden="true">
            <div class="sheet"><div class="lines"></div></div>
            <div class="sheet"><div class="lines"></div></div>
            <div class="sheet"><div class="lines"></div></div>
          </div>

          <!-- Envelope -->
          <div class="envelope" id="envelope" role="button" tabindex="0" aria-label="Open envelope">
            <div class="flap"></div>
            <div class="env-front"></div>
            <div class="env-lip"></div>
          </div>
        </div>
      </div>

      <!-- Full page viewer -->
      <div class="viewer" id="viewer">
        <div class="top-controls">
          <div style="display:flex; gap:8px;">
            <button class="btn" id="backBtn">Back</button>
            <button class="btn" id="resetBtn">Reset</button>
          </div>
          <div class="pager" id="pager">1 / 3</div>
        </div>

        <div class="pages" id="pages">
          <section class="page">
            <h1>Page 1</h1>
            <p>This is the first page shown after the letters unfold. Replace this with your main message.</p>
            <p>Swipe left/right to change pages.</p>
          </section>

          <section class="page">
            <h1>Page 2</h1>
            <p>Second page content — photos, memories, or a longer note.</p>
          </section>

          <section class="page">
            <h1>Page 3</h1>
            <p>Final page — signature, date, or closing line.</p>
          </section>
        </div>
      </div>

      <div class="hint" id="hint">
        Tap envelope → scroll/drag down to pull letters → swipe up to unfold → swipe left/right to change page
      </div>
    </div>
  </div>

  <script>
    (function(){
      const body = document.body;

      const envelope = document.getElementById('envelope');
      const letters = document.getElementById('letters');

      const viewer = document.getElementById('viewer');
      const pages = document.getElementById('pages');
      const pager = document.getElementById('pager');

      const statePill = document.getElementById('statePill');
      const gesturePill = document.getElementById('gesturePill');
      const hint = document.getElementById('hint');

      const backBtn = document.getElementById('backBtn');
      const resetBtn = document.getElementById('resetBtn');
      const canvas = document.getElementById('canvas');

      // States: closed -> opened -> pulling -> pulled -> unfolding -> unfolded
      let state = body.dataset.state;
      let pageIndex = 0;

      // Pull “scrub” progress 0..1 (0=peek, 1=fully out)
      let pull = 0;

      // Tune distances to match reference proportions
      const PEEK_Y = -18;        // opened peek position
      const PULL_DISTANCE = 170; // how far letters slide out

      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

      function setState(next){
        state = next;
        body.dataset.state = next;
        statePill.textContent = `State: ${next}`;
        hint.classList.toggle('hidden', next === 'unfolded');
        if(next === 'unfolded'){
          viewer.classList.add('active');
        } else {
          viewer.classList.remove('active');
        }
      }

      function setPage(i){
        pageIndex = clamp(i, 0, 2);
        pages.style.transform = `translateX(-${pageIndex * 33.3333}%)`;
        pager.textContent = `${pageIndex + 1} / 3`;
      }

      function applyPull(){
        // letters translate: peek + pullDistance * pull
        const y = PEEK_Y + (PULL_DISTANCE * pull);
        letters.style.transform = `translateY(${y}px)`;
        letters.style.opacity = 1;
      }

      function resetAll(){
        pull = 0;
        letters.style.transform = '';
        letters.style.opacity = '';
        setPage(0);
        setState('closed');
        gesturePill.textContent = 'Gesture: —';
      }

      // ===== Interaction 1: Tap to open =====
      function openEnvelope(){
        if(state === 'closed'){
          gesturePill.textContent = 'Gesture: tap';
          setState('opened');
          pull = 0;
          applyPull();
        }
      }
      envelope.addEventListener('click', openEnvelope);
      envelope.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' || e.key === ' ') openEnvelope();
      });

      // ===== Interaction 2: Scroll/drag down to pull letters out =====
      // Wheel / trackpad
      window.addEventListener('wheel', (e)=>{
        // Only react when opened/pulling/pulled and not unfolded
        if(state !== 'opened' && state !== 'pulling' && state !== 'pulled') return;

        // We interpret positive deltaY as “scroll down”
        const dy = e.deltaY;

        // prevent page scroll
        e.preventDefault();

        // If already pulled, allow small reverse with scroll up
        if(state === 'pulled' && dy < 0){
          gesturePill.textContent = 'Gesture: scroll up';
          setState('pulling');
        }

        if(state === 'opened') setState('pulling');

        // Normalize dy (trackpads can be small)
        pull = clamp(pull + (dy / 700), 0, 1);
        gesturePill.textContent = dy > 0 ? 'Gesture: scroll down' : 'Gesture: scroll up';
        applyPull();

        // Snap to pulled when threshold reached
        if(pull >= 1){
          pull = 1;
          applyPull();
          setState('pulled');
        } else if(pull <= 0 && state !== 'opened'){
          pull = 0;
          applyPull();
          setState('opened');
        }
      }, { passive:false });

      // Touch/mouse drag (down to pull)
      let isDown = false;
      let startX = 0, startY = 0;
      let lastX = 0, lastY = 0;
      let moved = false;

      function onDown(x,y){
        isDown = true;
        moved = false;
        startX = lastX = x;
        startY = lastY = y;
      }

      function onMove(x,y){
        if(!isDown) return;

        const dx = x - startX;
        const dy = y - startY;
        lastX = x; lastY = y;
        if(Math.abs(dx) > 6 || Math.abs(dy) > 6) moved = true;

        // Pull letters by dragging down when opened/pulling
        if(state === 'opened' || state === 'pulling' || state === 'pulled'){
          // If in opened and user drags down, start pulling
          if((state === 'opened' || state === 'pulled') && dy > 10){
            setState('pulling');
          }

          if(state === 'pulling'){
            // dy > 0 pulls out, dy < 0 pushes back
            pull = clamp(dy / PULL_DISTANCE, 0, 1);
            gesturePill.textContent = dy >= 0 ? 'Gesture: drag down' : 'Gesture: drag up';
            applyPull();

            if(pull >= 1){
              pull = 1;
              applyPull();
              setState('pulled');
            }
          }
        }
      }

      function onUp(){
        if(!isDown) return;
        isDown = false;

        const dx = lastX - startX;
        const dy = lastY - startY;

        // if no movement, ignore
        if(!moved) return;

        // ===== Interaction 3: Swipe up to unfold =====
        if(state === 'pulled' && dy < -70 && Math.abs(dy) > Math.abs(dx)){
          gesturePill.textContent = 'Gesture: swipe up';
          setState('unfolding');

          // Stagger feel: tiny delay before switching to viewer
          setTimeout(()=>{
            setState('unfolded');
            setPage(0);
          }, 260);
          return;
        }

        // allow returning to opened by dragging up a lot while pulling
        if((state === 'pulling' || state === 'pulled') && dy > 80 && pull < 0.4){
          pull = 0;
          applyPull();
          setState('opened');
        }

        // ===== Interaction 4: Swipe left/right pages (only unfolded) =====
        if(state === 'unfolded' && Math.abs(dx) > 70 && Math.abs(dx) > Math.abs(dy)){
          if(dx < 0){
            gesturePill.textContent = 'Gesture: swipe left';
            if(pageIndex < 2) setPage(pageIndex + 1);
            else bounceEdge();
          }else{
            gesturePill.textContent = 'Gesture: swipe right';
            if(pageIndex > 0) setPage(pageIndex - 1);
            else bounceEdge();
          }
        }
      }

      function bounceEdge(){
        // subtle “rubber band” on edges
        pages.style.transition = 'transform 140ms ease';
        const base = -pageIndex * 33.3333;
        const nudge = pageIndex === 0 ? 2 : -2;
        pages.style.transform = `translateX(calc(${base}% + ${nudge}px))`;
        setTimeout(()=>{
          pages.style.transition = 'transform 380ms cubic-bezier(.2,.9,.2,1)';
          pages.style.transform = `translateX(${base}%)`;
        }, 140);
      }

      canvas.addEventListener('touchstart', (e)=>{
        if(e.touches.length !== 1) return;
        const t = e.touches[0];
        onDown(t.clientX, t.clientY);
      }, { passive:true });

      canvas.addEventListener('touchmove', (e)=>{
        if(e.touches.length !== 1) return;
        const t = e.touches[0];
        onMove(t.clientX, t.clientY);
      }, { passive:true });

      canvas.addEventListener('touchend', onUp, { passive:true });

      canvas.addEventListener('mousedown', (e)=> onDown(e.clientX, e.clientY));
      window.addEventListener('mousemove', (e)=> onMove(e.clientX, e.clientY));
      window.addEventListener('mouseup', onUp);

      // Buttons
      backBtn.addEventListener('click', ()=>{
        // Back to “pulled” (still folded) to match the story
        gesturePill.textContent = 'Gesture: back';
        setState('pulled');
        pull = 1;
        applyPull();
      });

      resetBtn.addEventListener('click', resetAll);

      // init
      setPage(0);
      setState('closed');
    })();
  </script>
</body>
</html>
